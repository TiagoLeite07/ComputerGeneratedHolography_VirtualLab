<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Computer Generated Holography Virtual Lab</title>
    <link rel="stylesheet" href="css/base.css" />
</head>
<body>
    <div id="container"></div>

    <script src="js/three.min.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/controls/OrbitControls.js"></script>
    <script src="js/gui/stats.min.js"></script>
    <script src="js/Mirror.js"></script>
    <script src="js/gui/dat.gui.js"></script>
    <script src="js/csg.js"></script>
    <script src="js/ThreeCSG.js"></script>
    <script src="js/CGHLab.js"></script>
    <script src="js/scenes/main/mainScene.js"></script>
    <script src="js/scenes/main/objectPerspective.js"></script>
    <script src="js/scenes/main/mainPerspective.js"></script>
    <script src="js/scenes/main/platePerspective.js"></script>
    <script src="js/geometry/HoloObject.js"></script>
    <script src="js/holography/LightPoint.js"></script>
    <script src="js/holography/Wave.js"></script>
    <script src="js/holography/HologramShaderLib.js"></script>
    <script src="js/Helpers.js"></script>
    <script src="js/geometry/GeometryShaderLib.js"></script>

    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <link rel=stylesheet href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <link rel=stylesheet href="css/info.css"/>
    <script src="js/info.js"></script>
    <div id="infoButton"></div>
    <div id="infoBox" title="Lab Information">
        <!--This is a demo, part of a collection at
        <a href="http://stemkoski.github.io/Three.js/">http://stemkoski.github.io/Three.js/</a>-->
    </div>

    <script>
        if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

        var mainScene, camera, controls, renderer, objectPerspective, platePerspective;
        var container, stats;
        var gui = new dat.GUI();
        var gui2 = new dat.GUI();
        var currentPerspective;
        //var currentScene;
        //var laserTurnOn = false;
        var simpleLaserOn = false;
        var rotateCameraMain = false;
        var rotateCameraObj = false;
        var cameraRotationMain = 0;
        var cameraRotationMainMax = Math.PI/2;
        var cameraRotationObj = 0;
        var cameraRotationObjMax = Math.PI/2;
        var map, mapWidth = 240, mapHeight = 160;
        var camera2;

        var rayCaster;
        var mouse = new THREE.Vector2(), INTERSECTED, SELECTED;

        //var object, objectPosition, objectRotation, center;
        //var referenceWave;

        init();

        animate();

        function init() {
            container = document.getElementById('container');

            /*var test = document.getElementById('infoBox');
            var text = document.createTextNode("Bla bla bla");
            test.appendChild(text);
            while (test.hasChildNodes()) {
                test.removeChild(test.childNodes[0]);
            }*/

            ////RENDERER
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setClearColor(0x777777);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.autoClear = true;

            container.appendChild(renderer.domElement);

            ////CAMERA
            var aspect = window.innerWidth / window.innerHeight;

            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 10000);
            camera.position.set(0, 500, -350);

            //camera2 = new THREE.PerspectiveCamera(45, aspect, 0.1, 10000);
            //camera2.position.set(0, 500, -350);

            map = new THREE.OrthographicCamera(
                    window.innerWidth / -2,		// Left
                    window.innerWidth / 2,		// Right
                    window.innerHeight / 2,		// Top
                    window.innerHeight / -2,	// Bottom
                    -5000,            			// Near
                    10000 );           			// Far
            map.up = new THREE.Vector3(0,0,-1);
            map.lookAt( new THREE.Vector3(0,-1,0) );

            ////SCENES
            //spherescene = new THREE.Scene();
            //mainScene = new CGHLab.MainScene(renderer, camera);

            ////CONTROLS
            controls = new THREE.OrbitControls( camera, renderer.domElement );
            controls.target = new THREE.Vector3(0,0,0);
            controls.noPan = true;
            controls.maxPolarAngle = Math.PI/2;

            /*------------------------------------------------------------------------------*/
            ////GEOMETRY
            mainScene = new CGHLab.MainScene(renderer, camera, map, controls);
            mainScene.init();
            CGHLab.Helpers.addMainPerspectiveInfo();
            controls.target = mainScene.getCenter();

            /*---------------------------------------------------------------------------*/

            ////RAYCASTING
            rayCaster = new THREE.Raycaster();

            ////FPS COUNTER
            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            container.appendChild( stats.domElement );

            ////GUI
            setGUI('main');

            currentPerspective = 'main';

            ////CALLBACKS
            window.addEventListener( 'resize', onWindowResize, false );
            window.addEventListener( 'mousemove', onDocumentMouseMove, false );
            //window.addEventListener( 'mousedown', onDocumentMouseDown, false );
        }

        function setGUI( perspective )
        {
            gui.destroy();
            gui2.destroy();
            gui2 = new dat.GUI();
            gui2.open();

            var parametersGUIPerspectives = function()
            {
                this.mainPerspectiveChange = function(){
                    if(mainScene.objectPerspectiveChosen){
                        mainScene.objectPerspective.lastCameraPosition = camera.getWorldPosition();
                    }
                    mainScene.objectPerspectiveChosen = false;
                    mainScene.mainPerspectiveChosen = true;
                    mainScene.platePerspectiveChosen = false;
                    setGUI('main');
                };
                this.objectPerspectiveChange = function(){
                    if(mainScene.mainPerspectiveChosen){
                        mainScene.mainPerspective.lastCameraPosition = camera.getWorldPosition();
                    }
                    mainScene.objectPerspectiveChosen = true;
                    mainScene.mainPerspectiveChosen = false;
                    mainScene.platePerspectiveChosen = false;
                    setGUI('object');
                };
                this.platePerspectiveChange = function(){
                    if(mainScene.objectPerspectiveChosen){
                        mainScene.objectPerspective.lastCameraPosition = camera.getWorldPosition();
                    }
                    else if(mainScene.mainPerspectiveChosen){
                        mainScene.mainPerspective.lastCameraPosition = camera.getWorldPosition();
                    }
                    mainScene.objectPerspectiveChosen = false;
                    mainScene.mainPerspectiveChosen = false;
                    mainScene.platePerspectiveChosen = true;
                    setGUI('plate');
                };
                this.labelsOn = mainScene.labelsOn;
            };

            var guiPerspectivesConfig = new parametersGUIPerspectives();

            var folder3 = gui2.addFolder('Change Perspective');
            folder3.open();
            folder3.add(guiPerspectivesConfig, 'mainPerspectiveChange').name('To Main');
            folder3.add(guiPerspectivesConfig, 'objectPerspectiveChange').name('To Object');
            folder3.add(guiPerspectivesConfig, 'platePerspectiveChange').name('To Plate');
            var folder4 = gui2.addFolder('Other');
            folder4.open();
            var labelsOnOpt = folder4.add(guiPerspectivesConfig, 'labelsOn').name('Labels On?');
            labelsOnOpt.onChange(function(value){
                if(value) {
                    if (mainScene.laserOnFlag) mainScene.setBeamLabels();
                    mainScene.setLabels();
                    mainScene.labelsOn = true;
                }
                else {
                    mainScene.deleteAllLabels();
                    mainScene.labelsOn = false;
                }
            });

            if(perspective == 'main')
            {
                gui = new dat.GUI();
                gui.open();
                var parametersGUIMain = function()
                {
                    this.laserSimples = function(){if (!simpleLaserOn) mainScene.simpleLaser(); simpleLaserOn = true;};
                    this.laserOn = function(){if (!mainScene.laserOnFlag) mainScene.laserOn(); mainScene.laserOnFlag = true;};
                    this.laserOff = function(){if (mainScene.laserOnFlag) mainScene.laserOff(); mainScene.laserOnFlag = false;};
                    this.objectRotationSlider = CGHLab.Helpers.rad2deg(mainScene.objectRotationScene);
                    //this.focusCenter = function(){controls.target = mainScene.getCenter()};
                    this.geometry = mainScene.object.figure;
                    this.interferencePattern = function(){ mainScene.seeInterferencePattern(); };
                    this.refWaveLength = mainScene.referenceWave.waveLength;
                    this.refWaveAngle = CGHLab.Helpers.rad2deg(mainScene.referenceWaveAngle);
                    this.cameraLocked = mainScene.cameraFree;
                    this.view = mainScene.mainPerspective.currentViewName;
                    //this.teste = function(){mainScene.teste()};
                };

                /*var cubeRotation = gui.add(parameters, 'cubeRotation').min(0).listen();
                cubeRotation.onChange(function(value){
                    mainScene.updateObjectRotation(value)
                });*/

                var mainParametersConfig = new parametersGUIMain();

                var folderGeneralMain = gui.addFolder('General');
                folderGeneralMain.open();
                //folderGeneralMain.add(mainParametersConfig, 'teste').name('Teste');
                folderGeneralMain.add(mainParametersConfig, 'laserSimples').name('Simples');
                folderGeneralMain.add(mainParametersConfig, 'laserOn').name('Turn On Laser');
                folderGeneralMain.add(mainParametersConfig, 'laserOff').name('Turn Off Laser');
                //folderGeneralMain.add(mainParametersConfig, 'focusCenter').name('Focus Center');
                folderGeneralMain.add(mainParametersConfig, 'interferencePattern').name('See Interference Pattern');

                var lockCamera = folderGeneralMain.add(mainParametersConfig, 'cameraLocked').name('Free Camera?');
                lockCamera.onChange(function(value){
                    mainScene.lockCamera(value);
                    setGUI('main');
                });

                if (!mainScene.cameraFree) {
                    var viewsList = [1, 2, 3, 4];
                    var viewChosen = folderGeneralMain.add(mainParametersConfig, 'view', viewsList).name('View');
                    viewChosen.onChange(function (value) {
                        mainScene.mainPerspective.currentViewName = value;
                        cameraRotationMainMax = mainScene.mainPerspective.views[value - 1] - mainScene.mainPerspective.currentView;
                        rotateCameraMain = true;
                    });
                }

                var folderObjectMain = gui.addFolder('Object');
                folderObjectMain.open();
                var r = folderObjectMain.add( mainParametersConfig, 'objectRotationSlider').min(0).max(360).name('Rotation');
                r.onChange(function(value){
                    mainScene.mainPerspective.rotateObject(value);
                });
                var figureList = [ "cube", "sphere", "cylinder", "pyramid", "torus", "torus_knot" ];
                var geometry = folderObjectMain.add( mainParametersConfig, 'geometry', figureList ).name('Geometry');
                geometry.onChange(function(value)
                {
                    mainScene.mainPerspective.changeObject(value);
                });

                var folderRefWaveMain = gui.addFolder('Reference Wave');
                folderRefWaveMain.open();
                var wl = folderRefWaveMain.add(mainParametersConfig, 'refWaveLength').name('WaveLength');
                wl.onChange(function(value){
                    mainScene.referenceWave.waveLength = value;
                    mainScene.updateShaderUniforms();
                });
                var wa = folderRefWaveMain.add(mainParametersConfig, 'refWaveAngle').min(0).max(90).name('Wave Angle');
                wa.onChange(function(value){
                    mainScene.mainPerspective.updateMirror(value);
                });
            }

            else if(perspective == 'object')
            {
                gui = new dat.GUI();
                gui.open();

                var parametersGUIObject = function()
                {
                    this.laserOn = function(){if (!mainScene.laserOnFlag) mainScene.laserOn(); mainScene.laserOnFlag = true;};
                    this.laserOff = function(){if (mainScene.laserOnFlag) mainScene.laserOff(); mainScene.laserOnFlag = false;};
                    this.objectRotationSlider = CGHLab.Helpers.rad2deg(mainScene.objectRotationScene);
                    this.geometry = mainScene.object.figure;
                    this.detail = mainScene.object.detail;
                    this.simpleSending = mainScene.simpleWaveSending;
                    this.cameraLocked = mainScene.cameraFree;
                    this.view = mainScene.objectPerspective.currentViewName;
                    //this.teste = function(){mainScene.teste()};
                };
                // gui.add( parameters )
                var objectParametersConfig = new parametersGUIObject();

                var folderGeneralObject = gui.addFolder('General');
                folderGeneralObject.open();

                //folderGeneralObject.add(objectParametersConfig, 'teste').name('Teste');
                folderGeneralObject.add(objectParametersConfig, 'laserOn').name('Turn On Laser');
                folderGeneralObject.add(objectParametersConfig, 'laserOff').name('Turn Off Laser');

                var simpleSendingCheck = folderGeneralObject.add(objectParametersConfig, 'simpleSending').name('Simple Sending?');
                simpleSendingCheck.onChange(function(value){
                    mainScene.simpleWaveSending = value;
                });

                var lockCameraObj = folderGeneralObject.add(objectParametersConfig, 'cameraLocked').name('Free Camera?');
                lockCameraObj.onChange(function(value){
                    mainScene.lockCamera(value);
                    setGUI('object');
                });

                if (!mainScene.cameraFree) {
                    var viewsListObj = [1, 2, 3, 4];
                    var viewChosenObj = folderGeneralObject.add(objectParametersConfig, 'view', viewsListObj).name('View');
                    viewChosenObj.onChange(function (value) {
                        mainScene.objectPerspective.currentViewName = value;
                        cameraRotationObjMax = mainScene.objectPerspective.views[value - 1] - mainScene.objectPerspective.currentView;
                        rotateCameraObj = true;
                    });
                }

                var folderObjectObject = gui.addFolder('Object');
                folderObjectObject.open();
                var rObj = folderObjectObject.add( objectParametersConfig, 'objectRotationSlider').min(0).max(360).name('Rotation');
                rObj.onChange(function(value){
                    mainScene.objectPerspective.rotateObject(value);
                });
                var figureListObj = [ "cube", "sphere", "cylinder", "pyramid", "torus", "torus_knot" ];
                var geometryObj = folderObjectObject.add( objectParametersConfig, 'geometry', figureListObj ).name('Geometry');
                geometryObj.onChange(function(value)
                {
                    mainScene.objectPerspective.changeObject(value);
                    setGUI('object');
                });
                var detailList = [];
                if (mainScene.object.figure == 'sphere') detailList = [ "low", "high" ];
                else detailList = [ "low", "medium", "high" ];
                var detailObj = folderObjectObject.add( objectParametersConfig, 'detail', detailList ).name('Detail');
                detailObj.onChange(function(value)
                {
                    mainScene.objectPerspective.changeDetail(mainScene.object.figure, value);
                });
            }
            else if(perspective == 'plate')
            {
                gui = new dat.GUI();
                gui.open();

                var parametersGUIPlate = function()
                {
                    this.objectRotationSlider = CGHLab.Helpers.rad2deg(mainScene.objectRotationScene);
                    this.geometry = mainScene.object.figure;
                    this.interferencePattern = function(){ mainScene.seeInterferencePattern(); };
                    this.refWaveLength = mainScene.referenceWave.waveLength;
                    this.refWaveAngle = CGHLab.Helpers.rad2deg(mainScene.referenceWaveAngle);
                    this.detail = mainScene.object.detail;
                };
                // gui.add( parameters )

                var plateParametersConfig = new parametersGUIPlate();

                var folderGeneralPlate = gui.addFolder('General');
                folderGeneralPlate.open();
                folderGeneralPlate.add(plateParametersConfig, 'interferencePattern').name('See Interference Pattern');

                var folderObjectPlate = gui.addFolder('Object');
                folderObjectPlate.open();
                var rp = folderObjectPlate.add( plateParametersConfig, 'objectRotationSlider').min(0).max(360).name('Rotation');
                rp.onChange(function(value){
                    mainScene.mainPerspective.rotateObject(value);
                });
                var figureListPlate = [ "cube", "sphere", "cylinder", "pyramid", "torus", "torus_knot" ];
                var geometryPlate = folderObjectPlate.add( plateParametersConfig, 'geometry', figureListPlate ).name('Geometry');
                geometryPlate.onChange(function(value)
                {
                    mainScene.platePerspective.changeObject(value);
                    setGUI('plate');
                });

                var detailListPlate = [];
                if (mainScene.object.figure == 'sphere') detailListPlate = [ "low", "high" ];
                else detailListPlate = [ "low", "medium", "high" ];
                var detailObjPlate = folderObjectPlate.add( plateParametersConfig, 'detail', detailListPlate ).name('Detail');
                detailObjPlate.onChange(function(value)
                {
                    mainScene.platePerspective.changeDetail(mainScene.object.figure, value);
                });

                var folderRefWavePlate = gui.addFolder('Reference Wave');
                folderRefWavePlate.open();
                var wlp = folderRefWavePlate.add(plateParametersConfig, 'refWaveLength').name('WaveLength');
                wlp.onChange(function(value){
                    mainScene.referenceWave.waveLength = value;
                    mainScene.updateShaderUniforms();
                });
                var wap = folderRefWavePlate.add(plateParametersConfig, 'refWaveAngle').min(0).max(90).name('Wave Angle');
                wap.onChange(function(value){
                    mainScene.mainPerspective.updateMirror(value);
                });
            }
        }

        function onWindowResize()
        {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        /*function onDocumentMouseDown( event )
        {
            //event.preventDefault(); //Makes dat.GUI not work properly

            camera.updateMatrixWorld();

            rayCaster.setFromCamera( mouse, camera );

            var intersects = rayCaster.intersectObjects( mainScene.objects );

            if ( intersects.length > 0 ) {

                SELECTED = intersects[ 0 ].object;

                controls.target = SELECTED.position;

            }
        }*/

        function onDocumentMouseMove( event )
        {
            //event.preventDefault(); //Makes dat.GUI not work properly

            mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
        }

        function animate()
        {
            requestAnimationFrame( animate );
            render();
            update();
        }

        function render()
        {
            //camera.updateMatrixWorld();
            camera.updateProjectionMatrix();
            map.updateProjectionMatrix();

            if(rotateCameraMain) {
                if (cameraRotationMainMax > 0) {
                    if (cameraRotationMain < cameraRotationMainMax) {
                        mainScene.mainPerspective.changeView(1);
                        cameraRotationMain += 0.01;
                    }
                    else {
                        rotateCameraMain = false;
                        cameraRotationMain = 0;
                    }
                }
                else {
                    if (cameraRotationMain > cameraRotationMainMax) {
                        mainScene.mainPerspective.changeView(-1);
                        cameraRotationMain -= 0.01;
                    }
                    else {
                        rotateCameraMain = false;
                        cameraRotationMain = 0;
                    }
                }
            }

            if(rotateCameraObj) {
                if (cameraRotationObjMax > 0) {
                    if (cameraRotationObj < cameraRotationObjMax) {
                        mainScene.objectPerspective.changeView(1);
                        cameraRotationObj += 0.01;
                    }
                    else {
                        rotateCameraObj = false;
                        cameraRotationObj = 0;
                    }
                }
                else {
                    if (cameraRotationObj > cameraRotationObjMax) {
                        mainScene.objectPerspective.changeView(-1);
                        cameraRotationObj -= 0.01;
                    }
                    else {
                        rotateCameraObj = false;
                        cameraRotationObj = 0;
                    }
                }
            }

            if(mainScene.objectPerspectiveChosen){
                if(currentPerspective != 'object'){
                    controls.target = mainScene.objectPosition;
                    setGUI('object');
                    currentPerspective = 'object';
                    mainScene.changeToObjectPerspective();
                }
            }
            else if(mainScene.platePerspectiveChosen){
                if(currentPerspective != 'plate'){
                    controls.target = mainScene.platePosition;
                    setGUI('plate');
                    currentPerspective = 'plate';
                    mainScene.changeToPlatePerspective();
                }
            }
            else if(mainScene.mainPerspectiveChosen){
                if(currentPerspective != 'main'){
                    controls.target = mainScene.getCenter();
                    setGUI('main');
                    currentPerspective = 'main';
                    mainScene.changeToMainPerspective();
                }
            }

            var w = window.innerWidth, h = window.innerHeight;
            renderer.setViewport( 0, 0, w, h );
            renderer.clear();

            //renderer.setViewport( 10, h - mapHeight - 10, mapWidth, mapHeight );
            //renderer.render( mainScene.scene, map );

            mainScene.mirror.render();
            renderer.render(mainScene.scene, camera);

            //renderer.setViewport( 1, 1,   0.5 * w - 2, h - 2 );
            //renderer.render( mainScene.scene, camera );

            // right side
            //renderer.setViewport( 0.5 * w + 1, 1,   0.5 * w - 2, h - 2 );
            //renderer.render( mainScene.scene, map );
        }

        function update()
        {
            controls.update();
            stats.update();
            if (mainScene.laserOnFlag) mainScene.updateLaser();
        }
    </script>
</body>
</html>